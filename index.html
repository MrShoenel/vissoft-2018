<!DOCTYPE html>
<head>
  <title>VISSOFT 2018</title>
  <meta charset="utf-8">

  <script src="https://cdn.jsdelivr.net/npm/vega@3.2.1/build/vega.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@2.3.1/build/vega-lite.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@3.2.0/build/vega-embed.js"></script>

  <!-- Vega Tooltip -->
  <script src="https://cdn.jsdelivr.net/npm/vega-tooltip"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/vega-tooltip/build/vega-tooltip.min.css">

  <script src="https://d3js.org/d3.v5.min.js"></script>

  <script src="https://cdn.rawgit.com/karpathy/tsnejs/master/tsne.js"></script>

  <style media="screen">
    /* Add space between Vega-Embed links  */
    .vega-actions a {
      margin-right: 5px;
    }

    .container {
      /*display: flex;*/
    }

    #text {
      display: flex;
      justify-content: center;
    }

    #vis {
      /*overflow:auto;*/
      height:800px;
      width:1000px;
      /*border:1px solid black;*/
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>VISSOFT 2018</h1>
  <!-- Container for the visualizations -->
  <div class="container">
    <div id="text">t-SNE iterations: 0</div>
    <div id="vis"></div>
    <!-- <div id="scatter"></div> -->
  </div>
  

  <script>
  d3.csv("docs_16_comma_1000.csv?" + Math.random()).then(function(data) {
    // console.log("File loaded successfully!");

    // Filter data columns
    // data_columns = data.columns.filter(col => (col.startsWith("N_") || col.startsWith("R_")) && !col.endsWith("(score)"));
    data_columns = data.columns.filter(col => col.endsWith("(score)"));
    
    let row_specs = [];
    for (let col of data_columns) {  
      let vlSpec = {
        "width": 300,
        "height": 75,
        // "data": { "values": data },
        "mark": {
          "type": "point",
          // "interpolate": "monotone",
        },
        "encoding": {
          "x": {
            // "bin": {
            //   "maxbins": 30,
            // },
            "field": col.slice(0, -8),
            // "field": "#",
            "type": "quantitative",
            "axis": {
              "title": false
            },
          },
          "y": {
            "field": col,
            // "aggregate": "count",
            "type": "quantitative",
            "axis": {
              "title": col
            }
          },
          "opacity": {
            "condition": {
              "selection": "brush",
              "value": 1.0
            },
            "value": 0.1
          },
          "color": {
            "condition": {
              "selection": "brush",              
            },
            "value": "lightgray"
          },
          "size": {
            "condition": {
              "selection": "brush",
              "value": 100
            },
            "value": 50
          }
        }
      };
      row_specs.push(vlSpec);
    }
    
    let scatterSpec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v2.json",
      "width": 600,
      "height": 600,
      "description": "A scatterplot showing horsepower and miles per gallons.",
      // "data": { "name": "projection" },
      "selection": {
        "brush": {
          "type": "interval"
        }
      },
      "mark": "circle",
      "encoding": {
        "x": {"field": "proj_x", "type": "quantitative"},
        "y": {"field": "proj_y", "type": "quantitative"},
        "color": {
          "condition": {
            "selection": "brush",
            },
          "value": "grey"
        }
        // "shape": {"field": "y", "type": "nominal"}
      }
    };

    let finalSpec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v2.json",
      "data": { "name": "input_data" },
      "hconcat": [
        {
          "vconcat": row_specs
        },
        scatterSpec
      ]
    }

    // Embed the visualization in the container with id `vis`
    // vegaEmbed("#vis", finalSpec, {"actions": false});

    // vegaEmbed("#scatter", scatterSpec, {"actions": false})
    vegaEmbed("#vis", finalSpec, {"actions": false, "mode": "vega-lite"})
      .then(function(res) {
        // Insert the initial data
        res.view.insert("input_data", data).run();
        // console.log(data);

        // result.view is the Vega View, vlSpec is the original Vega-Lite specification
        vegaTooltip.vegaLite(res.view, finalSpec, {
          showAllFields: false,
          fields: [
            {
              field: "name",
            }
          ]
        });

        // Do the t-SNE
        var opt = {}
        opt.epsilon = 10; // epsilon is learning rate (10 = default)
        opt.perplexity = 30; // roughly how many neighbors each point influences (30 = default)
        opt.dim = 2; // dimensionality of the embedding (2 = default)

        var tsne = new tsnejs.tSNE(opt); // create a tSNE instance

        let dataRaw = data.map(row => data_columns.map(col => +row[col]));
        tsne.initDataRaw(dataRaw);

        // Pseudorandom initialization to ensure predictable outcomes
        tsne.Y = dataRaw.map(row => [random(), random()]);

        // doIterations(tsne, res.view, 0, 30);
        window.setTimeout(doIterations, 1, tsne, res.view, 0, 30);
      });

    function doIterations(tsne, view, i, maxIter) {
      j = i + 10;
      for (; i < j; ++i) {
        // console.log("Iteration", i);        
        tsne.step(); // every time you call this, solution gets better
      }
      document.getElementById("text").innerHTML = "t-SNE iterations: " + i;

      let Y = tsne.getSolution(); // Y is an array of 2-D points that you can plot

      let changeSet = vega.changeset();
      
      // changeSet.remove(x => true);
      // changeSet.insert(Y.map(row => ({"proj_x": row[0], "proj_y": row[1]})));

      for (let i = 0; i < data.length; ++i) {
        changeSet.modify(data[i], "proj_x", Y[i][0]);
        changeSet.modify(data[i], "proj_y", Y[i][1]);
      }      
      
      view.change('input_data', changeSet).run();

      if (i < maxIter) {
        window.setTimeout(doIterations, 1, tsne, view, i, maxIter);
      }
    }

  });

  // https://stackoverflow.com/questions/521295/seeding-the-random-number-generator-in-javascript
  var seed = 1;
  function random() {
      var x = Math.sin(seed++) * 10000;
      return x - Math.floor(x);
  }
  </script>
</body>
</html>